/*
******************************************************************************
File:     main.c
Info:     Generated by Atollic TrueSTUDIO(R) 9.0.1   2019-04-22
*/

/* Includes */
#include "General.h"
#include "clock_tjb.h"
#include "stm32f10x_tim.h"
#include "stm32f10x_adc.h"
#include "stm32f10x_usart.h"


int 	_write		(int fd, char *str, int len);
void 	uart_init	(void);
void 	new_input	(void);

const uint32_t      len				= 9;

volatile uint16_t 	new_sig 		= 0;
volatile uint16_t 	new_ref 		= 0;

volatile uint32_t	new_flag		= 0;
uint32_t			head			= 0;

const double 		k_bin_to_volt 	= 3.3 / 4095.0;

uint16_t 			ticks_start 	= 0;
uint16_t 			ticks_conv 		= 0;

enum  {
	f_coeff_no 	= 66,
	samples		= 100
};
// 5Hz passband, stopband and attenuation given below
const double 	f_coeff[f_coeff_no] = {
	//44 (60Hz, 10dB) //0.13069,0.012428,0.012971,0.013543,0.014047,0.014599,0.015073,0.015541,0.015962,0.016377,0.01676,0.017202,0.017534,0.017977,0.018164,0.018197,0.018667,0.018761,0.018933,0.019031,0.019077,0.019106,0.019106,0.019077,0.019031,0.018933,0.018761,0.018667,0.018197,0.018164,0.017977,0.017534,0.017202,0.01676,0.016377,0.015962,0.015541,0.015073,0.014599,0.014047,0.013543,0.012971,0.012428,0.13069
	//494(10Hz, 20dB) //-0.067508,0.00050034,0.00050911,0.00049789,0.00050787,0.00049694,0.00050837,0.00049713,0.00051083,0.00049811,0.000515,0.00049932,0.00052142,0.00049717,0.00053128,0.00046072,0.00052619,0.00062849,0.00054428,0.00056882,0.00054654,0.00056329,0.00055429,0.00056832,0.00056551,0.00057806,0.00057951,0.00059102,0.00059549,0.00060594,0.00061369,0.00061875,0.00065973,0.00064462,0.00064122,0.00066073,0.00066654,0.00068478,0.00069278,0.00071056,0.00071942,0.00073729,0.00074675,0.0007646,0.00077446,0.00079316,0.0008024,0.00082507,0.00083634,0.00083711,0.00086258,0.00087905,0.00089623,0.00091276,0.00092854,0.00094525,0.00096077,0.00097812,0.00099344,0.0010116,0.0010272,0.0010462,0.0010617,0.0010835,0.0010926,0.0011162,0.0011399,0.0011562,0.0011758,0.0011936,0.0012132,0.0012321,0.0012524,0.0012721,0.0012929,0.0013135,0.0013347,0.0013555,0.0013775,0.0013981,0.0014184,0.001447,0.001465,0.0014864,0.001508,0.0015305,0.0015531,0.0015761,0.0015991,0.0016222,0.0016457,0.0016688,0.0016923,0.0017154,0.0017394,0.0017615,0.001788,0.0018113,0.0018313,0.0018572,0.0018807,0.0019061,0.0019299,0.001955,0.0019788,0.0020039,0.0020279,0.0020527,0.002077,0.0021021,0.0021265,0.0021517,0.0021779,0.0021998,0.0022261,0.0022527,0.0022776,0.0023033,0.002328,0.0023535,0.0023782,0.002404,0.0024286,0.0024544,0.0024794,0.0025052,0.00253,0.0025564,0.0025803,0.0026052,0.0026327,0.002657,0.0026819,0.0027065,0.0027314,0.0027563,0.0027813,0.0028062,0.0028308,0.002856,0.0028805,0.0029053,0.0029297,0.0029544,0.0029776,0.0030037,0.0030276,0.0030506,0.0030749,0.0030987,0.0031229,0.0031467,0.0031706,0.0031939,0.0032177,0.003241,0.0032639,0.003287,0.00331,0.0033324,0.0033554,0.0033787,0.0033994,0.0034221,0.0034444,0.0034666,0.0034883,0.0035099,0.0035311,0.0035522,0.0035733,0.0035937,0.0036144,0.003635,0.0036552,0.0036751,0.0036957,0.0037145,0.0037336,0.0037539,0.0037726,0.0037916,0.0038098,0.0038283,0.0038462,0.0038644,0.0038819,0.0038994,0.0039169,0.003934,0.0039507,0.0039675,0.0039838,0.0039991,0.0040159,0.0040314,0.0040463,0.0040614,0.0040761,0.0040908,0.0041051,0.0041193,0.0041327,0.0041466,0.0041598,0.0041725,0.0041851,0.0041976,0.0042092,0.0042213,0.0042333,0.0042437,0.0042548,0.0042654,0.0042759,0.0042859,0.0042957,0.0043049,0.0043141,0.0043232,0.0043312,0.0043395,0.0043475,0.004355,0.0043623,0.0043699,0.004376,0.0043823,0.0043887,0.0043944,0.0043999,0.0044049,0.0044098,0.0044141,0.0044187,0.0044222,0.0044256,0.0044293,0.0044321,0.0044346,0.0044372,0.004439,0.0044401,0.004442,0.0044429,0.0044434,0.0044437,0.0044437,0.0044434,0.0044429,0.004442,0.0044401,0.004439,0.0044372,0.0044346,0.0044321,0.0044293,0.0044256,0.0044222,0.0044187,0.0044141,0.0044098,0.0044049,0.0043999,0.0043944,0.0043887,0.0043823,0.004376,0.0043699,0.0043623,0.004355,0.0043475,0.0043395,0.0043312,0.0043232,0.0043141,0.0043049,0.0042957,0.0042859,0.0042759,0.0042654,0.0042548,0.0042437,0.0042333,0.0042213,0.0042092,0.0041976,0.0041851,0.0041725,0.0041598,0.0041466,0.0041327,0.0041193,0.0041051,0.0040908,0.0040761,0.0040614,0.0040463,0.0040314,0.0040159,0.0039991,0.0039838,0.0039675,0.0039507,0.003934,0.0039169,0.0038994,0.0038819,0.0038644,0.0038462,0.0038283,0.0038098,0.0037916,0.0037726,0.0037539,0.0037336,0.0037145,0.0036957,0.0036751,0.0036552,0.003635,0.0036144,0.0035937,0.0035733,0.0035522,0.0035311,0.0035099,0.0034883,0.0034666,0.0034444,0.0034221,0.0033994,0.0033787,0.0033554,0.0033324,0.00331,0.003287,0.0032639,0.003241,0.0032177,0.0031939,0.0031706,0.0031467,0.0031229,0.0030987,0.0030749,0.0030506,0.0030276,0.0030037,0.0029776,0.0029544,0.0029297,0.0029053,0.0028805,0.002856,0.0028308,0.0028062,0.0027813,0.0027563,0.0027314,0.0027065,0.0026819,0.002657,0.0026327,0.0026052,0.0025803,0.0025564,0.00253,0.0025052,0.0024794,0.0024544,0.0024286,0.002404,0.0023782,0.0023535,0.002328,0.0023033,0.0022776,0.0022527,0.0022261,0.0021998,0.0021779,0.0021517,0.0021265,0.0021021,0.002077,0.0020527,0.0020279,0.0020039,0.0019788,0.001955,0.0019299,0.0019061,0.0018807,0.0018572,0.0018313,0.0018113,0.001788,0.0017615,0.0017394,0.0017154,0.0016923,0.0016688,0.0016457,0.0016222,0.0015991,0.0015761,0.0015531,0.0015305,0.001508,0.0014864,0.001465,0.001447,0.0014184,0.0013981,0.0013775,0.0013555,0.0013347,0.0013135,0.0012929,0.0012721,0.0012524,0.0012321,0.0012132,0.0011936,0.0011758,0.0011562,0.0011399,0.0011162,0.0010926,0.0010835,0.0010617,0.0010462,0.0010272,0.0010116,0.00099344,0.00097812,0.00096077,0.00094525,0.00092854,0.00091276,0.00089623,0.00087905,0.00086258,0.00083711,0.00083634,0.00082507,0.0008024,0.00079316,0.00077446,0.0007646,0.00074675,0.00073729,0.00071942,0.00071056,0.00069278,0.00068478,0.00066654,0.00066073,0.00064122,0.00064462,0.00065973,0.00061875,0.00061369,0.00060594,0.00059549,0.00059102,0.00057951,0.00057806,0.00056551,0.00056832,0.00055429,0.00056329,0.00054654,0.00056882,0.00054428,0.00062849,0.00052619,0.00046072,0.00053128,0.00049717,0.00052142,0.00049932,0.000515,0.00049811,0.00051083,0.00049713,0.00050837,0.00049694,0.00050787,0.00049789,0.00050911,0.00050034,-0.067508
	//66 (50Hz, 15dB) //
		0.078445,0.0078354,0.0082259,0.0085885,0.0089776,0.0093449,0.0097272,0.010094,0.010468,0.010802,0.011154,0.011444,0.011778,0.01206,0.012484,0.012768,0.012957,0.013313,0.013527,0.013805,0.014006,0.014244,0.014441,0.014628,0.014787,0.014937,0.015055,0.015171,0.015263,0.015364,0.015379,0.015438,0.015454,0.015454,0.015438,0.015379,0.015364,0.015263,0.015171,0.015055,0.014937,0.014787,0.014628,0.014441,0.014244,0.014006,0.013805,0.013527,0.013313,0.012957,0.012768,0.012484,0.01206,0.011778,0.011444,0.011154,0.010802,0.010468,0.010094,0.0097272,0.0093449,0.0089776,0.0085885,0.0082259,0.0078354,0.078445
	//78 (50Hz, 20dB) //0.049442,0.0058608,0.0061938,0.0065421,0.0068855,0.0072409,0.0075782,0.0079271,0.008254,0.0085914,0.0089073,0.0092538,0.0095903,0.0099612,0.010255,0.01051,0.010895,0.011168,0.011482,0.011762,0.012048,0.012316,0.012573,0.012818,0.013055,0.013287,0.013495,0.013687,0.01385,0.01403,0.014181,0.014304,0.01443,0.014521,0.014615,0.014672,0.014723,0.014758,0.014781,0.014781,0.014758,0.014723,0.014672,0.014615,0.014521,0.01443,0.014304,0.014181,0.01403,0.01385,0.013687,0.013495,0.013287,0.013055,0.012818,0.012573,0.012316,0.012048,0.011762,0.011482,0.011168,0.010895,0.01051,0.010255,0.0099612,0.0095903,0.0092538,0.0089073,0.0085914,0.008254,0.0079271,0.0075782,0.0072409,0.0068855,0.0065421,0.0061938,0.0058608,0.049442
	//100(40Hz, 20dB) //0.045496,0.0044487,0.0046569,0.0048653,0.0050742,0.0052866,0.0055036,0.0057238,0.0059481,0.0061753,0.0063975,0.0066124,0.0068159,0.0070097,0.0072203,0.0075216,0.00767,0.0079011,0.0081129,0.0083196,0.008522,0.00872,0.0089133,0.009103,0.0092944,0.009479,0.0096597,0.009831,0.0099889,0.010146,0.010319,0.01045,0.010599,0.010736,0.010866,0.01099,0.011106,0.011214,0.011311,0.011408,0.01149,0.01157,0.011641,0.011699,0.01175,0.011802,0.011829,0.011859,0.011876,0.011884,0.011884,0.011876,0.011859,0.011829,0.011802,0.01175,0.011699,0.011641,0.01157,0.01149,0.011408,0.011311,0.011214,0.011106,0.01099,0.010866,0.010736,0.010599,0.01045,0.010319,0.010146,0.0099889,0.009831,0.0096597,0.009479,0.0092944,0.009103,0.0089133,0.00872,0.008522,0.0083196,0.0081129,0.0079011,0.00767,0.0075216,0.0072203,0.0070097,0.0068159,0.0066124,0.0063975,0.0061753,0.0059481,0.0057238,0.0055036,0.0052866,0.0050742,0.0048653,0.0046569,0.0044487,0.045496
	//9	 (500Hz, 20dB)//0.0715, 0.0837, 0.1144, 0.1364, 0.1444, 0.1364, 0.1144, 0.0837, 0.0715
};

double 		sig		[samples];				// signal
double 		ref		[samples];				// reference
double 		x_mul	[samples];				// signal * reference
double 		x_lp	[samples];				// x_lock after low pass filter


double conv(double *x, uint32_t hd)
{
	double temp = 0; 	// reset to 0 before summing

	for(uint32_t i2 = 0; i2 < f_coeff_no; i2++)	// lpf coeff. loop
	{
		// sum[k=0 to N-1]  h(k) * x(n-k)
		// latest val multiplies with first coeff of filter
		// oldest val multiplies with last coeff of filter
		temp += x[((samples + hd) - i2) % samples] * f_coeff[i2];
	}
	return (temp);
}



int main(void)
{
	SystemInit();								// Set CLK source to HSE(8MHz) with SYSCLK = 72MHz

	// GPIO config for blinking PC13
	RCC->APB2ENR |= RCC_APB2ENR_IOPCEN;
	GPIOC->CRH |= GPIO_CRH_MODE13_1;			// GPIOC13 as output, max speed 2MHz
	GPIOC->CRH &= ~GPIO_CRH_CNF13;				// GPIOC13 as output push-pull

	// GPIO config for sq wave output from PB0
	RCC->APB2ENR |= RCC_APB2ENR_IOPBEN;
	GPIOB->CRL |= GPIO_CRL_MODE0_1;			// GPIOB0 as output, max speed 2MHz
	GPIOB->CRL &= ~GPIO_CRL_CNF0;			// GPIOB0 as output push-pull

	//systickInit(1000);
	uart_init();

	adc_init();
	adc_start();
	timer_init();

	printf("hi\r\n");
	ticks_start = TIM2->CNT;
	ticks_conv = 0;

	/* ADC TEST CODE
	 * while(1)
	{
		//new_input();;
		new_sig  = ADC1->DR;
		count++;
		if(count > 100*1000)
		{
			char output[30];
			gcvt((((double)new_sig / 4095.0) * 3.3),10,output);
			printf("\t%s \r\n", output);
			count = 0;
		}
	}*/

	uint32_t 	count           = 0;
	uint32_t 	phase 	        = 0;
	uint32_t	ph_calib_flag	= 0;

	const uint32_t	ph_calib_samples = f_coeff_no * 10;

	while(1)
	{
		ticks_conv 	= TIM2->CNT + (new_flag * F_SAMPLE) - ticks_start;
		// Take one input
		new_input();
		// multiply sig and ref
		x_mul[head] = sig[head] * ref[(samples + head - phase) % samples];

		// convolution
		x_lp[head] = conv(x_mul, head);

		count++;
		if(!ph_calib_flag)
		{
			static uint32_t i1 	= 0;
			static double 	avg = 0;
			static double 	opti_max 	= 0;
			static uint32_t opti_phase	= 0xFF;
			avg += x_lp[head];
			i1++;
			if(i1 >= ph_calib_samples)
			{
				avg /= ph_calib_samples;
				char output2[10];
				gcvt(avg,6,output2);
				printf("phase = %d \t #%s \r\n", phase, output2);

				// save current phase as optimum phase if average amplitude is highest
				if(avg > opti_max)
				{
					opti_max 	= avg;
					opti_phase 	= phase;
				}
				phase++;

				if(phase >= (1000/F_SAMPLE))
				{
					ph_calib_flag = 1;
					phase = opti_phase;
					printf("OPTIMUM PHASE : %d\r\n", opti_phase);
				}
				avg = 0;
				i1 = 0;
			}
		}

		// print every 500ms
		// print '*' if processing time is more than sampling interval
		if(count >= (500000/F_SAMPLE))
		{
			count = 0;
			if(ticks_conv > F_SAMPLE)
			{USART1->DR = '*';}
			printf("\t*%d ", (ticks_conv));

			char output1[10];
			gcvt(x_lp[head],6,output1);
			printf("\t%s \r\n", output1);

		}

		head 	= (head + 1) % samples;
	}

	while(1)
	{
	  GPIOC->BSRR |= GPIO_BSRR_BS13;	// Set GPIOC13
	  delay_ms(100);
	  GPIOC->BSRR |= GPIO_BSRR_BR13;	// Reset GPIOC13
	  delay_ms(100);
	}
}

void new_input(void)
{
	// wait till new value is available
	while((ADC1->SR & ADC_SR_EOC) == 0)
	{;}
/*	if(new_flag > 1)
	{printf("\t**%d \r\n", new_flag);}*/

	ticks_start	= TIM2->CNT;

	new_sig  = ADC1->DR;
	new_ref  = ADC2->DR;

	sig[head] = ((double)new_sig * k_bin_to_volt);	// TODO: put a const for calc
	ref[head] = ((double)new_ref * k_bin_to_volt);

	new_flag = 0;
}

void uart_init()
{
	RCC->APB2ENR |= (RCC_APB2ENR_USART1EN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_AFIOEN);
	AFIO->MAPR |= AFIO_MAPR_USART1_REMAP;
	GPIOB->CRL |= GPIO_CRL_CNF6_1 | GPIO_CRL_MODE6 | GPIO_CRL_CNF7_0;

	USART_Cmd(USART1, ENABLE);

	USART_InitTypeDef USART_INITstructure;
	USART_INITstructure.USART_BaudRate 				= 115200;
	USART_INITstructure.USART_HardwareFlowControl 	= USART_HardwareFlowControl_None;
	USART_INITstructure.USART_Mode 					= USART_Mode_Tx | USART_Mode_Rx;
	USART_INITstructure.USART_Parity				= USART_Parity_No;
	USART_INITstructure.USART_StopBits				= USART_StopBits_1;
	USART_INITstructure.USART_WordLength			= USART_WordLength_8b;
	USART_Init(USART1, &USART_INITstructure);
}

int _write(int fd, char *str, int len)
{
	if(fd == 1)
	{
		for(int i1 = 0; i1<len; i1++)
		{
			while (!(USART1->SR & USART_SR_TXE))
			{;}
			USART1->DR = str[i1];
		}
	}
	return (len);
}

